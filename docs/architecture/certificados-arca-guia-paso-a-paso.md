# Gu√≠a Paso a Paso: Uso de Certificados ARCA/AFIP

## üìã √çndice

1. [Obtenci√≥n del Certificado ARCA](#1-obtenci√≥n-del-certificado-arca)
2. [Configuraci√≥n en el Sistema](#2-configuraci√≥n-en-el-sistema)
3. [Implementaci√≥n T√©cnica](#3-implementaci√≥n-t√©cnica)
4. [Proceso de Autenticaci√≥n WSAA](#4-proceso-de-autenticaci√≥n-wsaa)
5. [Uso en Servicios ARCA](#5-uso-en-servicios-arca)
6. [Troubleshooting](#6-troubleshooting)

---

## 1. Obtenci√≥n del Certificado ARCA

### üìã **Paso 1.1: Generar Clave Privada**

```bash
# Crear directorio para certificados
mkdir -p certs
cd certs

# Generar clave privada RSA de 2048 bits
openssl genrsa -out arca-private.key 2048

# Verificar la clave generada
openssl rsa -in arca-private.key -text -noout
```

### üìã **Paso 1.2: Crear Certificate Signing Request (CSR)**

```bash
# Generar CSR
openssl req -new -key arca-private.key -out arca-request.csr -subj "/C=AR/ST=Buenos Aires/L=CABA/O=TU_EMPRESA/CN=TU_CUIT"

# Verificar el CSR
openssl req -in arca-request.csr -text -noout
```

### üìã **Paso 1.3: Solicitar Certificado en ARCA**

1. **Ingresar a ARCA** con Clave Fiscal Nivel 3
2. **Navegar a**: `Administrador de Relaciones de Clave Fiscal` > `Certificados Digitales`
3. **Seleccionar**: "Web Services"
4. **Subir el CSR**: `arca-request.csr`
5. **Descargar certificado**: Guardarlo como `arca-cert.pem`

### üìã **Paso 1.4: Verificar Certificado**

```bash
# Verificar el certificado descargado
openssl x509 -in arca-cert.pem -text -noout

# Verificar que la clave privada coincida con el certificado
openssl x509 -noout -modulus -in arca-cert.pem | openssl md5
openssl rsa -noout -modulus -in arca-private.key | openssl md5
# Los hashes deben ser id√©nticos
```

---

## 2. Configuraci√≥n en el Sistema

### üìã **Paso 2.1: Estructura de Archivos**

```
proyecto/
‚îú‚îÄ‚îÄ certs/
‚îÇ   ‚îú‚îÄ‚îÄ arca-cert.pem       # Certificado p√∫blico
‚îÇ   ‚îú‚îÄ‚îÄ arca-private.key    # Clave privada
‚îÇ   ‚îî‚îÄ‚îÄ .gitignore          # Excluir certs del repositorio
‚îú‚îÄ‚îÄ .env
‚îî‚îÄ‚îÄ .env.example
```

### üìã **Paso 2.2: Configuraci√≥n de Variables de Entorno**

**Opci√≥n A: Archivos (Recomendado para desarrollo)**

```bash
# .env
ARCA_ENVIRONMENT=homologacion  # o 'produccion'
ARCA_CUIT=20123456789

# Rutas a certificados
ARCA_CERT_PATH=./certs/arca-cert.pem
ARCA_KEY_PATH=./certs/arca-private.key

# Cache y timeouts
ARCA_CACHE_TTL_SECONDS=3600
TOKEN_EXPIRY_BUFFER_HOURS=1
REQUEST_TIMEOUT_MS=30000
```

**Opci√≥n B: Variables de entorno (Recomendado para producci√≥n)**

```bash
# .env
ARCA_ENVIRONMENT=produccion
ARCA_CUIT=20123456789

# Certificados como variables de entorno (m√°s seguro)
ARCA_CERT_CONTENT="-----BEGIN CERTIFICATE-----
MIIDXTCCAkWgAwIBAgIJAKoK/OvD...
-----END CERTIFICATE-----"

ARCA_KEY_CONTENT="-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcw...
-----END PRIVATE KEY-----"
```

### üìã **Paso 2.3: Seguridad de Certificados**

```bash
# Configurar permisos restrictivos
chmod 600 certs/arca-private.key
chmod 644 certs/arca-cert.pem

# Agregar a .gitignore
echo "certs/" >> .gitignore

# Para producci√≥n: usar variables de entorno o secrets manager
```

---

## 3. Implementaci√≥n T√©cnica

### üìã **Paso 3.1: Carga de Certificados en el C√≥digo**

El sistema autom√°ticamente carga los certificados seg√∫n esta prioridad:

```javascript
// src/server/services/arca-service.js - loadCertificates()

// 1. Prioridad: Variables de entorno (PROD)
if (this.config.ARCA_CERT_CONTENT && this.config.ARCA_KEY_CONTENT) {
    this.certificateContent = this.config.ARCA_CERT_CONTENT;
    this.privateKeyContent = this.config.ARCA_KEY_CONTENT;
}
// 2. Alternativa: Archivos (DEV)
else if (this.config.ARCA_CERT_PATH && this.config.ARCA_KEY_PATH) {
    this.certificateContent = await readFile(this.config.ARCA_CERT_PATH, 'utf8');
    this.privateKeyContent = await readFile(this.config.ARCA_KEY_PATH, 'utf8');
}
```

### üìã **Paso 3.2: Inicializaci√≥n del Servicio**

```javascript
// Ejemplo de inicializaci√≥n
import { ARCAService } from './services/arca-service.js';
import { CacheService } from './services/cache-service.js';

const config = {
    ARCA_ENVIRONMENT: process.env.ARCA_ENVIRONMENT,
    ARCA_CUIT: process.env.ARCA_CUIT,
    ARCA_CERT_PATH: process.env.ARCA_CERT_PATH,
    ARCA_KEY_PATH: process.env.ARCA_KEY_PATH,
    // ... m√°s configuraci√≥n
};

const cacheService = new CacheService();
const arcaService = new ARCAService(config, cacheService);

// Inicializar (carga certificados)
await arcaService.initialize();
```

---

## 4. Proceso de Autenticaci√≥n WSAA

### üìã **Paso 4.1: Flujo de Autenticaci√≥n**

```mermaid
sequenceDiagram
    participant App as Aplicaci√≥n
    participant WSAA as WSAA ARCA
    participant WS as Servicio ARCA

    App->>App: 1. Crear Login Ticket Request (TRA)
    App->>App: 2. Firmar TRA con certificado
    App->>WSAA: 3. Enviar LoginCms(TRA firmado)
    WSAA->>App: 4. Devolver Token + Sign
    App->>WS: 5. Usar Token/Sign para servicios
    WS->>App: 6. Respuesta del servicio
```

### üìã **Paso 4.2: Creaci√≥n del Login Ticket Request (TRA)**

```javascript
// El sistema autom√°ticamente crea el TRA
createLoginTicketRequest(service) {
    const now = new Date();
    const expiry = new Date(now.getTime() + (12 * 60 * 60 * 1000)); // 12 horas
    
    return `<?xml version="1.0" encoding="UTF-8"?>
    <loginTicketRequest version="1.0">
        <header>
            <uniqueId>${Date.now()}</uniqueId>
            <generationTime>${now.toISOString().replace('Z', '-03:00')}</generationTime>
            <expirationTime>${expiry.toISOString().replace('Z', '-03:00')}</expirationTime>
        </header>
        <service>${service}</service>
    </loginTicketRequest>`;
}
```

### üìã **Paso 4.3: Firma Criptogr√°fica del TRA**

```javascript
// NOTA: La implementaci√≥n actual es simplificada
// En producci√≥n debe usar firma CMS/PKCS#7 real

async signLoginTicketRequest(loginTicketRequest) {
    // TODO: Implementar firma CMS real con certificado
    // Debe usar: certificateContent + privateKeyContent
    
    // Implementaci√≥n temporal para desarrollo:
    return Buffer.from(loginTicketRequest).toString('base64');
}
```

‚ö†Ô∏è **IMPORTANTE**: La firma actual es una implementaci√≥n simplificada. Para producci√≥n, necesitas implementar firma CMS/PKCS#7 real.

### üìã **Paso 4.4: Obtenci√≥n y Cache de Tokens**

```javascript
// Uso autom√°tico en el c√≥digo
const token = await arcaService.authenticateWSAA('wsfe');

// El sistema autom√°ticamente:
// 1. Verifica si hay token en cache v√°lido
// 2. Si no, genera nuevo TRA
// 3. Firma el TRA con certificado
// 4. Solicita token a WSAA
// 5. Cachea token con TTL
// 6. Retorna token v√°lido
```

---

## 5. Uso en Servicios ARCA

### üìã **Paso 5.1: Facturaci√≥n Electr√≥nica (WSFEV1)**

```javascript
// Ejemplo: Solicitar CAE
const request = {
    FeCAEReq: {
        FeCabReq: {
            CantReg: 1,
            PtoVta: 1,
            CbteTipo: 1
        },
        FeDetReq: [{
            Concepto: 1,
            DocTipo: 80,
            DocNro: "20123456789",
            CbteDesde: 1,
            CbteHasta: 1,
            CbteFch: "20241225",
            ImpTotal: 121.00,
            ImpNeto: 100.00,
            ImpIVA: 21.00,
            MonId: "PES",
            MonCotiz: 1,
            Iva: [{
                Id: 5,
                BaseImp: 100.00,
                Importe: 21.00
            }]
        }]
    }
};

// El certificado se usa autom√°ticamente
const response = await arcaService.solicitarCAE(request);
```

### üìã **Paso 5.2: Consulta de Par√°metros**

```javascript
// Obtener tipos de comprobantes
const tiposComprobante = await arcaService.getParametros('FEParamGetTiposCbte');

// Obtener al√≠cuotas de IVA
const tiposIVA = await arcaService.getParametros('FEParamGetTiposIva');

// Obtener cotizaci√≥n de moneda
const cotizacion = await arcaService.getParametros('FEParamGetCotizacion', { MonId: 'USD' });
```

### üìã **Paso 5.3: Consulta de Estado de Contribuyentes**

```javascript
// Para implementar (servicio recomendado)
// WS_SR_CONSTANCIA_INSCRIPCION
const estadoContribuyente = await arcaService.consultarEstadoCUIT('20123456789');
```

---

## 6. Troubleshooting

### üîç **Error: "No certificate configuration found"**

```javascript
// Verificar variables de entorno
console.log('ARCA_CERT_PATH:', process.env.ARCA_CERT_PATH);
console.log('ARCA_KEY_PATH:', process.env.ARCA_KEY_PATH);
console.log('ARCA_CERT_CONTENT:', process.env.ARCA_CERT_CONTENT ? 'SET' : 'NOT SET');

// Verificar archivos existen
const fs = require('fs');
if (fs.existsSync(process.env.ARCA_CERT_PATH)) {
    console.log('Certificate file exists');
} else {
    console.log('Certificate file NOT found');
}
```

### üîç **Error: "WSAA authentication failed"**

1. **Verificar certificado v√°lido**:
```bash
openssl x509 -in certs/arca-cert.pem -noout -dates
```

2. **Verificar conectividad**:
```bash
curl -I https://wsaahomo.afip.gov.ar/ws/services/LoginService
```

3. **Verificar CUIT habilitado**:
   - Ingresar a ARCA con Clave Fiscal
   - Verificar habilitaci√≥n para Web Services

### üîç **Error: "Token expired"**

```javascript
// Verificar estado del token
const authStatus = await arcaService.checkAuthStatus();
console.log('Token v√°lido:', authStatus.valid);
console.log('Tiempo restante:', authStatus.timeLeft, 'segundos');

// Limpiar cache si necesario
// (Se renueva autom√°ticamente)
```

### üîç **Error de Firma CMS**

‚ö†Ô∏è **Limitaci√≥n actual**: La implementaci√≥n de firma est√° simplificada

**Para producci√≥n necesitas**:
1. Implementar firma CMS/PKCS#7 real
2. Usar librer√≠as como `node-forge` o `crypto`
3. Seguir especificaciones ARCA exactas

### üîç **Verificaci√≥n de Configuraci√≥n Completa**

```javascript
// Verificar servicio completamente configurado
const healthCheck = await arcaService.healthCheck();
console.log('Estado ARCA:', healthCheck.status);
console.log('WSAA conectado:', healthCheck.wsaa);
console.log('Token expira:', healthCheck.tokenExpiry);
```

---

## üéØ Resumen de Comandos Clave

```bash
# 1. Generar certificado
openssl genrsa -out certs/arca-private.key 2048
openssl req -new -key certs/arca-private.key -out certs/arca-request.csr

# 2. Configurar permisos
chmod 600 certs/arca-private.key
chmod 644 certs/arca-cert.pem

# 3. Configurar variables
echo "ARCA_CERT_PATH=./certs/arca-cert.pem" >> .env
echo "ARCA_KEY_PATH=./certs/arca-private.key" >> .env

# 4. Verificar configuraci√≥n
npm run test:arca-connection
```

## üìö Referencias T√©cnicas

- **C√≥digo principal**: `src/server/services/arca-service.js`
- **Configuraci√≥n**: `.env.example` l√≠neas 37-42
- **Documentaci√≥n ARCA**: https://www.arca.gob.ar/
- **Especificaciones WSAA**: Portal de desarrolladores ARCA