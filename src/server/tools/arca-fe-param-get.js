/**
 * FE Param Get Tool - Obtiene par√°metros de configuraci√≥n de ARCA/AFIP
 * Implementa los m√©todos FEParamGet* de WSFEV1
 */

import { Logger } from '../../../../utils/logger.js';

const logger = new Logger('FEParamGetTool');

export class FEParamGetTool {
    constructor(arcaService, cacheService) {
        this.arcaService = arcaService;
        this.cacheService = cacheService;
        this.methods = {
            'arca_fe_param_get_tipos_cbte': 'FEParamGetTiposCbte',
            'arca_fe_param_get_tipos_iva': 'FEParamGetTiposIva',
            'arca_fe_param_get_tipos_doc': 'FEParamGetTiposDoc',
            'arca_fe_param_get_tipos_monedas': 'FEParamGetTiposMonedas',
            'arca_fe_param_get_cotizacion': 'FEParamGetCotizacion',
            'arca_fe_param_get_puntos_venta': 'FEParamGetPtosVenta',
            'arca_fe_param_get_actividades': 'FEParamGetActividades'
        };
    }

    /**
     * Get tool definitions for MCP registration
     */
    getToolDefinitions() {
        return [
            {
                name: 'arca_fe_param_get_tipos_cbte',
                description: 'Obtiene los tipos de comprobantes v√°lidos para facturaci√≥n electr√≥nica',
                inputSchema: {
                    type: 'object',
                    properties: {},
                    additionalProperties: false
                }
            },
            {
                name: 'arca_fe_param_get_tipos_iva',
                description: 'Obtiene las al√≠cuotas de IVA v√°lidas',
                inputSchema: {
                    type: 'object',
                    properties: {},
                    additionalProperties: false
                }
            },
            {
                name: 'arca_fe_param_get_tipos_doc',
                description: 'Obtiene los tipos de documentos v√°lidos',
                inputSchema: {
                    type: 'object',
                    properties: {},
                    additionalProperties: false
                }
            },
            {
                name: 'arca_fe_param_get_tipos_monedas',
                description: 'Obtiene las monedas v√°lidas para facturaci√≥n',
                inputSchema: {
                    type: 'object',
                    properties: {},
                    additionalProperties: false
                }
            },
            {
                name: 'arca_fe_param_get_cotizacion',
                description: 'Obtiene la cotizaci√≥n de una moneda espec√≠fica',
                inputSchema: {
                    type: 'object',
                    properties: {
                        MonId: {
                            type: 'string',
                            description: 'C√≥digo de moneda (ej: USD, EUR)',
                            minLength: 3,
                            maxLength: 3
                        }
                    },
                    required: ['MonId']
                }
            },
            {
                name: 'arca_fe_param_get_puntos_venta',
                description: 'Obtiene los puntos de venta habilitados para facturaci√≥n electr√≥nica',
                inputSchema: {
                    type: 'object',
                    properties: {},
                    additionalProperties: false
                }
            },
            {
                name: 'arca_fe_param_get_actividades',
                description: 'Obtiene las actividades vigentes del contribuyente',
                inputSchema: {
                    type: 'object',
                    properties: {},
                    additionalProperties: false
                }
            }
        ];
    }

    /**
     * Execute parameter retrieval tool
     */
    async execute(toolName, args = {}) {
        try {
            logger.info(`Executing FE parameter tool: ${toolName}`, { args });

            const methodName = this.methods[toolName];
            if (!methodName) {
                throw new Error(`Unknown parameter method: ${toolName}`);
            }

            // Get parameters from ARCA service
            const response = await this.arcaService.getParametros(methodName, args);

            // Format response based on tool type
            return this.formatResponse(toolName, response, args);

        } catch (error) {
            logger.error(`FE parameter tool execution failed: ${toolName}`, {
                error: error.message,
                args
            });

            return {
                content: [{
                    type: 'text',
                    text: `‚ùå **Error obteniendo par√°metros**\n\n**M√©todo:** ${toolName}\n**Error:** ${error.message}\n\n**Posibles causas:**\n‚Ä¢ Problemas de conectividad con ARCA\n‚Ä¢ Token de autenticaci√≥n expirado\n‚Ä¢ Servicio ARCA no disponible`
                }],
                isError: true
            };
        }
    }

    /**
     * Format response based on tool type
     */
    formatResponse(toolName, response, args) {
        const { ResultGet, Errors } = response;

        // Check for errors
        if (Errors && Errors.length > 0) {
            const errorText = Errors.map(err => `‚Ä¢ **${err.Code}:** ${err.Msg}`).join('\n');
            return {
                content: [{
                    type: 'text',
                    text: `‚ùå **Error en consulta de par√°metros**\n\n${errorText}`
                }],
                isError: true
            };
        }

        // Format based on specific tool
        switch (toolName) {
            case 'arca_fe_param_get_tipos_cbte':
                return this.formatTiposComprobante(ResultGet);

            case 'arca_fe_param_get_tipos_iva':
                return this.formatTiposIva(ResultGet);

            case 'arca_fe_param_get_tipos_doc':
                return this.formatTiposDocumento(ResultGet);

            case 'arca_fe_param_get_tipos_monedas':
                return this.formatTiposMonedas(ResultGet);

            case 'arca_fe_param_get_cotizacion':
                return this.formatCotizacion(ResultGet, args.MonId);

            case 'arca_fe_param_get_puntos_venta':
                return this.formatPuntosVenta(ResultGet);

            case 'arca_fe_param_get_actividades':
                return this.formatActividades(ResultGet);

            default:
                return this.formatGeneric(toolName, ResultGet);
        }
    }

    /**
     * Format tipos de comprobante
     */
    formatTiposComprobante(data) {
        if (!data || !Array.isArray(data)) {
            return {
                content: [{
                    type: 'text',
                    text: '‚ö†Ô∏è **No se encontraron tipos de comprobantes**'
                }]
            };
        }

        let responseText = `üìÑ **Tipos de Comprobantes Disponibles**\n\n`;
        responseText += `Total encontrados: ${data.length}\n\n`;

        // Group by common types
        const facturas = data.filter(item => item.Desc?.toLowerCase().includes('factura'));
        const notasCredito = data.filter(item => item.Desc?.toLowerCase().includes('nota') && item.Desc?.toLowerCase().includes('cr√©dito'));
        const notasDebito = data.filter(item => item.Desc?.toLowerCase().includes('nota') && item.Desc?.toLowerCase().includes('d√©bito'));
        const otros = data.filter(item =>
            !item.Desc?.toLowerCase().includes('factura') &&
            !item.Desc?.toLowerCase().includes('nota')
        );

        if (facturas.length > 0) {
            responseText += `**üìã Facturas:**\n`;
            facturas.forEach(item => {
                responseText += `‚Ä¢ **${item.Id}** - ${item.Desc}\n`;
            });
            responseText += `\n`;
        }

        if (notasCredito.length > 0) {
            responseText += `**üí∞ Notas de Cr√©dito:**\n`;
            notasCredito.forEach(item => {
                responseText += `‚Ä¢ **${item.Id}** - ${item.Desc}\n`;
            });
            responseText += `\n`;
        }

        if (notasDebito.length > 0) {
            responseText += `**üìà Notas de D√©bito:**\n`;
            notasDebito.forEach(item => {
                responseText += `‚Ä¢ **${item.Id}** - ${item.Desc}\n`;
            });
            responseText += `\n`;
        }

        if (otros.length > 0) {
            responseText += `**üìù Otros Comprobantes:**\n`;
            otros.forEach(item => {
                responseText += `‚Ä¢ **${item.Id}** - ${item.Desc}\n`;
            });
        }

        return {
            content: [{
                type: 'text',
                text: responseText
            }]
        };
    }

    /**
     * Format tipos de IVA
     */
    formatTiposIva(data) {
        if (!data || !Array.isArray(data)) {
            return {
                content: [{
                    type: 'text',
                    text: '‚ö†Ô∏è **No se encontraron al√≠cuotas de IVA**'
                }]
            };
        }

        let responseText = `üíπ **Al√≠cuotas de IVA Disponibles**\n\n`;
        responseText += `Total encontradas: ${data.length}\n\n`;

        data.forEach(item => {
            responseText += `‚Ä¢ **${item.Id}** - ${item.Desc}`;
            if (item.FchDesde) {
                responseText += ` (Vigente desde: ${this.formatDate(item.FchDesde)})`;
            }
            responseText += `\n`;
        });

        responseText += `\n**Al√≠cuotas m√°s comunes:**\n`;
        responseText += `‚Ä¢ **5** - 21% (Al√≠cuota general)\n`;
        responseText += `‚Ä¢ **4** - 10.5% (Al√≠cuota reducida)\n`;
        responseText += `‚Ä¢ **6** - 27% (Al√≠cuota especial)\n`;
        responseText += `‚Ä¢ **8** - 5% (Al√≠cuota m√≠nima)\n`;
        responseText += `‚Ä¢ **9** - 2.5% (Al√≠cuota espec√≠fica)\n`;

        return {
            content: [{
                type: 'text',
                text: responseText
            }]
        };
    }

    /**
     * Format tipos de documento
     */
    formatTiposDocumento(data) {
        if (!data || !Array.isArray(data)) {
            return {
                content: [{
                    type: 'text',
                    text: '‚ö†Ô∏è **No se encontraron tipos de documentos**'
                }]
            };
        }

        let responseText = `üÜî **Tipos de Documentos V√°lidos**\n\n`;
        responseText += `Total encontrados: ${data.length}\n\n`;

        // Group by common types
        const principales = data.filter(item => [80, 86, 87, 96].includes(parseInt(item.Id)));
        const otros = data.filter(item => ![80, 86, 87, 96].includes(parseInt(item.Id)));

        if (principales.length > 0) {
            responseText += `**üìã Documentos Principales:**\n`;
            principales.forEach(item => {
                let emoji = '';
                switch (parseInt(item.Id)) {
                    case 80: emoji = 'üè¢'; break;
                    case 86: emoji = 'üë§'; break;
                    case 87: emoji = 'üåç'; break;
                    case 96: emoji = 'üìÑ'; break;
                }
                responseText += `‚Ä¢ **${item.Id}** ${emoji} - ${item.Desc}\n`;
            });
            responseText += `\n`;
        }

        if (otros.length > 0) {
            responseText += `**üìù Otros Documentos:**\n`;
            otros.forEach(item => {
                responseText += `‚Ä¢ **${item.Id}** - ${item.Desc}\n`;
            });
        }

        responseText += `\n**Documentos m√°s utilizados:**\n`;
        responseText += `‚Ä¢ **80** - CUIT (Personas jur√≠dicas)\n`;
        responseText += `‚Ä¢ **86** - CUIL (Personas f√≠sicas)\n`;
        responseText += `‚Ä¢ **87** - CDI (Extranjeros)\n`;
        responseText += `‚Ä¢ **96** - DNI (Consumidor final)\n`;

        return {
            content: [{
                type: 'text',
                text: responseText
            }]
        };
    }

    /**
     * Format tipos de monedas
     */
    formatTiposMonedas(data) {
        if (!data || !Array.isArray(data)) {
            return {
                content: [{
                    type: 'text',
                    text: '‚ö†Ô∏è **No se encontraron tipos de monedas**'
                }]
            };
        }

        let responseText = `üí± **Monedas Disponibles para Facturaci√≥n**\n\n`;
        responseText += `Total encontradas: ${data.length}\n\n`;

        // Separate peso from foreign currencies
        const peso = data.filter(item => item.Id === 'PES');
        const extranjeras = data.filter(item => item.Id !== 'PES').sort((a, b) => a.Id.localeCompare(b.Id));

        if (peso.length > 0) {
            responseText += `**üí∞ Moneda Nacional:**\n`;
            peso.forEach(item => {
                responseText += `‚Ä¢ **${item.Id}** - ${item.Desc}`;
                if (item.FchDesde) {
                    responseText += ` (Vigente desde: ${this.formatDate(item.FchDesde)})`;
                }
                responseText += `\n`;
            });
            responseText += `\n`;
        }

        if (extranjeras.length > 0) {
            responseText += `**üåç Monedas Extranjeras:**\n`;
            extranjeras.forEach(item => {
                responseText += `‚Ä¢ **${item.Id}** - ${item.Desc}`;
                if (item.FchDesde) {
                    responseText += ` (Vigente desde: ${this.formatDate(item.FchDesde)})`;
                }
                responseText += `\n`;
            });
        }

        responseText += `\n**Nota:** Para monedas extranjeras, debes obtener la cotizaci√≥n usando \`arca_fe_param_get_cotizacion\``;

        return {
            content: [{
                type: 'text',
                text: responseText
            }]
        };
    }

    /**
     * Format cotizaci√≥n de moneda
     */
    formatCotizacion(data, monId) {
        if (!data) {
            return {
                content: [{
                    type: 'text',
                    text: `‚ö†Ô∏è **No se encontr√≥ cotizaci√≥n para la moneda: ${monId}**`
                }]
            };
        }

        let responseText = `üí± **Cotizaci√≥n de Moneda**\n\n`;
        responseText += `**Moneda:** ${monId}\n`;
        responseText += `**Cotizaci√≥n:** $${data.MonCotiz || 'No disponible'}\n`;

        if (data.FchCotiz) {
            responseText += `**Fecha de Cotizaci√≥n:** ${this.formatDate(data.FchCotiz)}\n`;
        }

        responseText += `\n**Importante:** Esta cotizaci√≥n es orientativa y debe usarse para la facturaci√≥n electr√≥nica.`;

        return {
            content: [{
                type: 'text',
                text: responseText
            }]
        };
    }

    /**
     * Format puntos de venta
     */
    formatPuntosVenta(data) {
        if (!data || !Array.isArray(data)) {
            return {
                content: [{
                    type: 'text',
                    text: '‚ö†Ô∏è **No se encontraron puntos de venta habilitados**'
                }]
            };
        }

        let responseText = `üè™ **Puntos de Venta Habilitados**\n\n`;
        responseText += `Total encontrados: ${data.length}\n\n`;

        data.forEach(item => {
            responseText += `‚Ä¢ **Punto de Venta ${item.Nro}**`;
            if (item.EmisionTipo) {
                responseText += ` - Tipo: ${item.EmisionTipo}`;
            }
            if (item.Bloqueado) {
                responseText += ` ‚ö†Ô∏è (Bloqueado)`;
            }
            if (item.FchBaja) {
                responseText += ` üö´ (Dado de baja: ${this.formatDate(item.FchBaja)})`;
            }
            responseText += `\n`;
        });

        const activos = data.filter(item => !item.Bloqueado && !item.FchBaja);
        responseText += `\n**Resumen:**\n`;
        responseText += `‚Ä¢ Puntos de venta activos: ${activos.length}\n`;
        responseText += `‚Ä¢ Total configurados: ${data.length}`;

        return {
            content: [{
                type: 'text',
                text: responseText
            }]
        };
    }

    /**
     * Format actividades del contribuyente
     */
    formatActividades(data) {
        if (!data || !Array.isArray(data)) {
            return {
                content: [{
                    type: 'text',
                    text: '‚ö†Ô∏è **No se encontraron actividades del contribuyente**'
                }]
            };
        }

        let responseText = `üè≠ **Actividades del Contribuyente**\n\n`;
        responseText += `Total encontradas: ${data.length}\n\n`;

        data.forEach((item, index) => {
            responseText += `**${index + 1}.** C√≥digo: **${item.IdActividad}**\n`;
            responseText += `   Descripci√≥n: ${item.DescActividad}\n`;
            if (item.Nomenclador) {
                responseText += `   Nomenclador: ${item.Nomenclador}\n`;
            }
            if (item.Orden) {
                responseText += `   Orden: ${item.Orden}\n`;
            }
            responseText += `\n`;
        });

        return {
            content: [{
                type: 'text',
                text: responseText
            }]
        };
    }

    /**
     * Format generic response
     */
    formatGeneric(toolName, data) {
        let responseText = `üìä **Par√°metros obtenidos - ${toolName}**\n\n`;

        if (Array.isArray(data)) {
            responseText += `Total de elementos: ${data.length}\n\n`;
            data.forEach((item, index) => {
                responseText += `**${index + 1}.** `;
                if (item.Id !== undefined) responseText += `ID: ${item.Id} - `;
                if (item.Desc) responseText += `${item.Desc}`;
                if (item.Descripcion) responseText += `${item.Descripcion}`;
                responseText += `\n`;
            });
        } else {
            responseText += JSON.stringify(data, null, 2);
        }

        return {
            content: [{
                type: 'text',
                text: responseText
            }]
        };
    }

    /**
     * Format date from YYYYMMDD to readable format
     */
    formatDate(dateStr) {
        if (!dateStr || dateStr.length !== 8) return dateStr;

        const year = dateStr.substring(0, 4);
        const month = dateStr.substring(4, 6);
        const day = dateStr.substring(6, 8);

        return `${day}/${month}/${year}`;
    }
}